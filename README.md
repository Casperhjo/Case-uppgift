Code written by Casper Hjorth and Eric Pettersson
